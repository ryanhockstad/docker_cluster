#!/bin/bash

# set -o allexport; source .env; set +o allexport
export $(xargs <.env)

if  ! docker volume ls | grep -q es_certs
then
  cd make_certs
  docker-compose up
  cd ..
fi


docker-compose up -d --remove-orphans node-1 node-2 node-3 logstash kibana wait_until_ready nginx


# Ping elastic until we get a response
docker cp node-1:/usr/share/elasticsearch/config/certs/ca/ca.crt .
until curl --cacert ./ca.crt -s -u elastic:$ELASTIC_PASSWORD https://localhost:9200
do
  sleep 0.1
done

# Load ILM
until curl -XPUT "https://localhost:9200/_ilm/policy/filebeat_policy" --cacert ./ca.crt -s -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -d '{"policy": {"phases":{"hot": {"min_age":"0ms","actions": {"rollover": {"max_size": "50gb","max_age": "30d"},"set_priority": {"priority": 100}}},"delete": {"min_age": "30d","actions": {"delete": {"delete_searchable_snapshot": true}}}}}}'
do
  sleep 0.1
done 

# Loading pipelines with bash. Doesn't work because maybe bash version?
# cd /Users/ryanhockstad/projects/JFL/ecs-mapping/automatic_install
# /Users/ryanhockstad/projects/JFL/ecs-mapping/automatic_install/test.sh <<< $'y\n127.0.0.1\n9200\ny\nelastic\n$ELASTIC_PASSWORD\nhttps\nn\nn\n/Users/ryanhockstad/ELK/docker/cluster/ca.crt\ny'
# cd /Users/ryanhockstad/ELK/docker/cluster

# Load pipelines with python
cd /Users/ryanhockstad/projects/JFL/ecs-mapping/automatic_install
until (python pipelines_import.py << ANSWERS
localhost
9200
y
elastic
$ELASTIC_PASSWORD
y
y
y
ANSWERS
)
do
  sleep 1
done
cd /Users/ryanhockstad/ELK/docker/cluster

# Create corelight template
until curl -XPUT "https://localhost:9200/_index_template/corelight_template" --cacert ./ca.crt -s -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -d '{"index_patterns": ["filebeat-corelight"],"data_stream": {},"template": {"mappings" : {"dynamic_templates" : [{"strings_as_keyword" : {"match_mapping_type" : "string","mapping" : {"fields" : {"text" : {"type" : "text"}},"ignore_above" : 4096,"type" : "keyword"}}},{"numeric_long_fields" : {"match_mapping_type" : "long","mapping" : {"type" : "long"}}},{"numeric_double_fields" : {"match_mapping_type" : "double","mapping" : {"type" : "double"}}},{"boolean_fields" : {"match_mapping_type" : "boolean","mapping" : {"type" : "boolean"}}},{"zeek_ssh_stepping_ips" : {"path_match" : "ssh.stepping.*_ip","mapping" : {"copy_to" : "related.ip","type" : "ip"}}},{"zeek_ssh_stepping_uids" : {"path_match" : "ssh.stepping.uid*","mapping" : {"copy_to" : "related.id","type" : "keyword"}}}],"properties" : {"@timestamp" : {"type" : "date"},"client" : {"properties" : {"viz" : {"properties" : {"clr_ex" : {"type" : "text"},"clr_frac" : {"type" : "float"},"enc_dev" : {"type" : "float"},"enc_frac" : {"type" : "float"},"pdu1_enc" : {"type" : "boolean"},"size" : {"type" : "long"}}}}},"conn" : {"properties" : {"duration" : {"type" : "float"},"history" : {"type" : "keyword","ignore_above" : 1024},"ip_bytes" : {"type" : "long"},"local_orig" : {"type" : "boolean"},"local_resp" : {"type" : "boolean"},"missed_bytes" : {"type" : "long"},"state" : {"type" : "keyword","ignore_above" : 1024  }}  },  "destination" : {"properties" : {  "address" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {  "type" : "text"}}  },  "as" : {"properties" : {  "number" : {"type" : "long"  },"organization" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}}}},"bytes" : {"type" : "long"},"domain" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"file" : {"properties" : {"extension" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"fqdn" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"geo" : {"properties" : {"city_name" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"continent_code" : {"type" : "keyword","ignore_above" : 1024},"continent_name" : {"type" : "keyword","ignore_above" : 1024},"country_code2" : {"type" : "keyword","ignore_above" : 1024},"country_code3" : {"type" : "keyword","ignore_above" : 1024},"country_iso_code" : {"type" : "keyword","ignore_above" : 1024},"country_name" : {"type" : "keyword","ignore_above" : 1024},"location" : {"type" : "geo_point"},"name" : {"type" : "keyword","ignore_above" : 1024},"postal_code" : {"type" : "keyword","ignore_above" : 1024},"region_iso_code" : {"type" : "keyword","ignore_above" : 1024},"region_name" : {"type" : "keyword","ignore_above" : 1024},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"hostname" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"ip_public" : {"type" : "boolean"},"ip_type" : {"type" : "keyword"},"ip_version" : {"type" : "keyword"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"packets" : {"type" : "long"},"port" : {"type" : "long"},"user" : {"properties" : {"full_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword"}}}}},"dhcp" : {"properties" : {"agent_remote_id" : {"type" : "keyword","ignore_above" : 4096},"assigned_addr" : {"type" : "ip","copy_to" : ["related.ip"]},"circuit_id" : {"type" : "keyword","ignore_above" : 4096},"client_fqdn" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"client_message" : {"type" : "keyword","ignore_above" : 4096},"client_software" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"lease_time" : {"type" : "float"},"msg_orig" : {"type" : "ip","copy_to" : ["related.ip"]},"msg_types" : {"type" : "keyword","ignore_above" : 4096},"requested_addr" : {"type" : "ip","copy_to" : ["related.ip"]},"server_message" : {"type" : "keyword","ignore_above" : 4096},"server_software" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"subscriber_id" : {"type" : "keyword","ignore_above" : 4096}}},"dns" : {"properties" : {"answers" : {"properties" : {"class" : {"type" : "keyword","ignore_above" : 1024},"data" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ttl" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"answers_count" : {"type" : "long"},"header_flags" : {"type" : "keyword","ignore_above" : 1024},"id" : {"type" : "keyword","ignore_above" : 1024},"op_code" : {"type" : "keyword","ignore_above" : 1024},"question" : {"properties" : {"class" : {"type" : "keyword","ignore_above" : 1024},"etld_plus_one" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"registered_domain" : {"type" : "keyword","ignore_above" : 1024},"resolved_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"type" : {"type" : "keyword","ignore_above" : 1024}}},"response_code" : {"type" : "keyword","ignore_above" : 1024},"status_code" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"event" : {"properties" : {"category" : {"type" : "keyword","ignore_above" : 1024},"created" : {"type" : "date"},"dataset" : {"type" : "keyword","ignore_above" : 1024},"duration" : {"type" : "long"},"end" : {"type" : "date"},"facility" : {"type" : "keyword"},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword","ignore_above" : 1024},"kind" : {"type" : "keyword","ignore_above" : 1024},"module" : {"type" : "keyword","ignore_above" : 1024},"original" : {"type" : "keyword","index" : false,"doc_values" : false},"outcome" : {"type" : "keyword","ignore_above" : 1024},"priority" : {"type" : "keyword"},"risk_score" : {"type" : "float"},"risk_score_norm" : {"type" : "float"},"severity" : {"type" : "keyword"},"start" : {"type" : "date"},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"file" : {"properties" : {"accessed" : {"type" : "date"},"changed" : {"type" : "alias","path" : "file.ctime"},"created" : {"type" : "date"},"ctime" : {"type" : "date"},"device" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"directory" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"extension" : {"type" : "keyword","ignore_above" : 1024},"gid" : {"type" : "keyword","ignore_above" : 1024},"group" : {"type" : "keyword","ignore_above" : 1024},"hash" : {"properties" : {"imphash" : {"type" : "keyword","ignore_above" : 4096,"copy_to" : ["related.hash"]},"md5" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"murmur3" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha1" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha256" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha512" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"ssdeep" : {"type" : "keyword","ignore_above" : 4096,"copy_to" : ["related.hash"]}}},"inode" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"mode" : {"type" : "keyword","ignore_above" : 1024},"modified" : {"type" : "alias","path" : "file.mtime"},"mtime" : {"type" : "date"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"owner" : {"type" : "keyword","ignore_above" : 1024},"path" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"size" : {"type" : "long"},"system" : {"type" : "keyword","ignore_above" : 1024},"target_path" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"type" : {"type" : "keyword","ignore_above" : 1024},"uuid" : {"type" : "keyword","ignore_above" : 1024},"x509" : {"properties" : {"certificate" : {"properties" : {"basic_constraints" : {"properties" : {"ca" : {"type" : "boolean"},"path_length" : {"type" : "long"}}},"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"exponent" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"issuer" : {"properties" : {"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"country" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"distinguished_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"locality" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organization" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organizational_unit" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"state_or_province" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"logcert" : {"type" : "boolean"},"not_after" : {"type" : "date"},"not_before" : {"type" : "date"},"public_key_algorithm" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"public_key_curve" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"public_key_exponent" : {"type" : "long"},"public_key_size" : {"type" : "long"},"public_key_type" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_dns" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_email" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"san_url" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"serial_number" : {"type" : "keyword"},"signature_algorithm" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"subject" : {"properties" : {"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"country" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"distinguished_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"locality" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organization" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organizational_unit" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"state_or_province" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"version_number" : {"type" : "keyword"}}}}},"files" : {"properties" : {"analyzers" : {"type" : "keyword","ignore_above" : 1024},"depth" : {"type" : "long"},"entropy" : {"type" : "double"},"extracted" : {"type" : "keyword","ignore_above" : 1024},"extracted_cutoff" : {"type" : "boolean"},"extracted_size" : {"type" : "long"},"is_originating" : {"type" : "boolean"},"local_origin" : {"type" : "boolean"},"missing_bytes" : {"type" : "long"},"overflow_bytes" : {"type" : "long"},"seen_bytes" : {"type" : "long"},"timedout" : {"type" : "boolean"}}},"host" : {"properties" : {"architecture" : {"type" : "keyword","ignore_above" : 1024},"host" : {"type" : "keyword","copy_to" : ["related.domain"]},"hostname" : {"type" : "keyword","copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"port" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"http" : {"properties" : {"cookie_variables" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"request" : {"properties" : {"body" : {"properties" : {"bytes" : {"type" : "long"},"content" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"bytes" : {"type" : "long"},"header_names" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"method" : {"type" : "keyword","ignore_above" : 4096},"mime_type" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"origin" : {"type" : "keyword","ignore_above" : 4096},"proxied" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"referrer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"response" : {"properties" : {"body" : {"properties" : {"bytes" : {"type" : "long"},"content" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"bytes" : {"type" : "long"},"header_names" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"informational_code" : {"type" : "long"},"informational_message" : {"type" : "keyword","ignore_above" : 4096},"mime_type" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"status_code" : {"type" : "long"},"status_name" : {"type" : "keyword","ignore_above" : 4096}}},"transaction_depth" : {"type" : "long"},"version" : {"type" : "keyword","ignore_above" : 4096}}},"labels" : {"properties" : {"weird" : {"properties" : {"name" : {"type" : "text"},"number_seen" : {"type" : "integer"}}}}},"log" : {"properties" : {"id" : {"properties" : {"cert_chain_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"client_cert_chain_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"client_cert_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"conn_uids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"flow_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"orig_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"parent_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"related_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"resp_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"server_cert_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"suri_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"tunnel_parents" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"tx_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]}}},"level" : {"type" : "keyword","ignore_above" : 1024},"logger" : {"type" : "keyword"},"original" : {"type" : "keyword","index" : false,"doc_values" : false},"syslog" : {"properties" : {"facility" : {"properties" : {"code" : {"type" : "long"},"name" : {"type" : "keyword"}}},"priority" : {"type" : "long"},"severity" : {"properties" : {"code" : {"type" : "long"},"name" : {"type" : "keyword"}}}}}}},"message" : {"type" : "text","norms" : false},"network" : {"properties" : {"bytes" : {"type" : "long"},"community_id" : {"type" : "keyword","ignore_above" : 1024},"direction" : {"type" : "keyword","ignore_above" : 1024},"forwarded_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"iana_number" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 1024},"packets" : {"type" : "long"},"protocol" : {"type" : "keyword","ignore_above" : 1024},"transport" : {"type" : "keyword","ignore_above" : 1024},"type" : {"type" : "keyword","ignore_above" : 1024},"vlan" : {"properties" : {"id" : {"type" : "integer"},"inner" : {"properties" : {"vlan" : {"properties" : {"id" : {"type" : "integer"}}}}}}}}},"observer" : {"properties" : {"hostname" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.domain"]},"ip" : {"type" : "ip"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"sensor_version" : {"type" : "keyword"},"serial_number" : {"type" : "keyword"},"sub_process" : {"type" : "keyword"},"type" : {"type" : "keyword"},"vendor" : {"type" : "keyword"},"version" : {"type" : "keyword"}}},"radius" : {"properties" : {"connect_info" : {"type" : "keyword","ignore_above" : 2048},"framed" : {"type" : "ip","copy_to" : ["related.ip"]},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"reply_msg" : {"type" : "keyword","ignore_above" : 2048},"time_to_live" : {"type" : "float"},"tunnel_client" : {"type" : "keyword","ignore_above" : 4096}}},"related" : {"properties" : {"domain" : {"type" : "keyword"},"geo" : {"type" : "geo_point"},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"ip" : {"type" : "ip"},"mac" : {"type" : "keyword"},"user" : {"type" : "keyword"},"vlan_id" : {"type" : "integer"}}},"rule" : {"properties" : {"author" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"category" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"description" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"id" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"license" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"reference" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"ruleset" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"uuid" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"version" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"server" : {"properties" : {"viz" : {"properties" : {"clr_ex" : {"type" : "text"},"clr_frac" : {"type" : "float"},"enc_dev" : {"type" : "float"},"enc_frac" : {"type" : "float"},"pdu1_enc" : {"type" : "boolean"},"size" : {"type" : "long"}}}}},"socks" : {"properties" : {"bound" : {"properties" : {"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"}}},"request" : {"properties" : {"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"}}}}},"source" : {"properties" : {"address" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"as" : {"properties" : {"number" : {"type" : "long"},"organization" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}}}},"bytes" : {"type" : "long"},"domain" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"file" : {"properties" : {"extension" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"fqdn" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"geo" : {"properties" : {"city_name" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"continent_code" : {"type" : "keyword","ignore_above" : 1024},"continent_name" : {"type" : "keyword","ignore_above" : 1024},"country_code2" : {"type" : "keyword","ignore_above" : 1024},"country_code3" : {"type" : "keyword","ignore_above" : 1024},"country_iso_code" : {"type" : "keyword","ignore_above" : 1024},"country_name" : {"type" : "keyword","ignore_above" : 1024},"location" : {"type" : "geo_point"},"name" : {"type" : "keyword","ignore_above" : 1024},"postal_code" : {"type" : "keyword","ignore_above" : 1024},"region_iso_code" : {"type" : "keyword","ignore_above" : 1024},"region_name" : {"type" : "keyword","ignore_above" : 1024},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"hostname" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"ip_public" : {"type" : "boolean"},"ip_type" : {"type" : "keyword"},"ip_version" : {"type" : "keyword"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"packets" : {"type" : "long"},"port" : {"type" : "long"},"user" : {"properties" : {"full_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword"}}}}},"ssh" : {"properties" : {"auth_attempts" : {"type" : "long"},"auth_successful" : {"type" : "boolean"},"stepping" : {"properties" : {"direct" : {"type" : "boolean"},"dt" : {"type" : "float"}}}}},"suricata" : {"properties" : {"metadata" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"pcap_count" : {"type" : "long"}}},"tags" : {"type" : "keyword"},"tls" : {"properties" : {"cipher" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"client" : {"properties" : {"hash" : {"properties" : {"sha1" : {"type" : "keyword","ignore_above" : 1024}}},"issuer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ja3" : {"type" : "keyword","ignore_above" : 1024},"server_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"subject" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"curve" : {"type" : "keyword"},"established" : {"type" : "boolean"},"next_protocol" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"resumed" : {"type" : "boolean"},"server" : {"properties" : {"hash" : {"properties" : {"sha1" : {"type" : "keyword","ignore_above" : 1024}}},"issuer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ja3s" : {"type" : "keyword","ignore_above" : 1024},"subject" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"version" : {"type" : "keyword","ignore_above" : 1024},"version_protocol" : {"type" : "keyword","ignore_above" : 1024}}},"url" : {"properties" : {"domain" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"extension" : {"type" : "keyword","ignore_above" : 1024},"fragment" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"full" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"meta" : {"properties" : {"has_non_ascii" : {"type" : "boolean"},"has_whitespace" : {"type" : "boolean"},"paths" : {"type" : "long"},"total_length" : {"type" : "long"}}},"original" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword","ignore_above" : 1024},"path" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"},"query" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"scheme" : {"type" : "keyword","ignore_above" : 1024},"username" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.user"]},"variables" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}}}},"user_agent" : {"properties" : {"build" : {"type" : "keyword","ignore_above" : 1024},"device" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}},"major" : {"type" : "long"},"meta" : {"properties" : {"total_length" : {"type" : "long"}}},"minor" : {"type" : "long"},"minor2" : {"type" : "long"},"minor3" : {"type" : "long"},"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"original" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"os" : {"properties" : {"family" : {"type" : "keyword","ignore_above" : 1024},"full" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"kernel" : {"type" : "keyword","ignore_above" : 1024},"major" : {"type" : "keyword","ignore_above" : 1024},"minor" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 2048},"platform" : {"type" : "keyword","ignore_above" : 1024},"version" : {"type" : "keyword","ignore_above" : 1024}}},"patch" : {"type" : "keyword","ignore_above" : 1024},"version" : {"type" : "keyword","ignore_above" : 1024}}  }},"runtime": {  "counterflow_link": {"type": "keyword","script": {"source": "if (doc['\''source.ip'\''].size() != 0 && doc['\''destination.ip'\''].size() != 0) { String api_endpoint = '\''https://172.27.227.173/#/search/614e2800-1761-11ea-8000-3cecef425e98?nsbpf_query=host%20'\''; String host1 = doc['\''source.ip'\''].value; String host2 = doc['\''destination.ip'\''].value; ZonedDateTime zdt = doc['\''@timestamp'\''].value; zdt = zdt.minusMinutes(5); String timestamp = zdt.toString(); timestamp = timestamp.substring(0,timestamp.indexOf('\''Z'\'')); String begin = timestamp.substring(0,timestamp.indexOf('\''.'\'')) + '\''Z'\''; String url = api_endpoint + host1 + '\''%20and%20host%20'\'' + host2; if (doc['\''source.port'\''].size() != 0) { String port = doc['\''source.port'\''].value.toString(); url = url + '\''%20and%20port%20'\'' + port; } if (doc['\''destination.port'\''].size() != 0) { String port = doc['\''destination.port'\''].value.toString(); url = url + '\''%20and%20port%20'\'' + port; } emit(url + '\''&from_time='\'' + begin + '\''&to_time=%2B600'\'') }"}  }}},"settings" : {"index" : {  "refresh_interval" : "15s",  "number_of_shards" : "1",  "default_pipeline" : "xpack-corelight_main_pipeline",  "number_of_replicas" : "0",  "lifecycle.name": "filebeat_policy"}}  }}'
do
  sleep 0.1
done

# Create corelight template
until curl -XPUT "https://localhost:9200/_index_template/inquest_template" --cacert ./ca.crt -s -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -d '{"index_patterns": ["filebeat-inquest"],"data_stream": {},"template": {"mappings" : {"dynamic_templates" : [{"strings_as_keyword" : {"match_mapping_type" : "string","mapping" : {"fields" : {"text" : {"type" : "text"}},"ignore_above" : 4096,"type" : "keyword"}}},{"numeric_long_fields" : {"match_mapping_type" : "long","mapping" : {"type" : "long"}}},{"numeric_double_fields" : {"match_mapping_type" : "double","mapping" : {"type" : "double"}}},{"boolean_fields" : {"match_mapping_type" : "boolean","mapping" : {"type" : "boolean"}}},{"zeek_ssh_stepping_ips" : {"path_match" : "ssh.stepping.*_ip","mapping" : {"copy_to" : "related.ip","type" : "ip"}}},{"zeek_ssh_stepping_uids" : {"path_match" : "ssh.stepping.uid*","mapping" : {"copy_to" : "related.id","type" : "keyword"}}}],"properties" : {"@timestamp" : {"type" : "date"},"client" : {"properties" : {"viz" : {"properties" : {"clr_ex" : {"type" : "text"},"clr_frac" : {"type" : "float"},"enc_dev" : {"type" : "float"},"enc_frac" : {"type" : "float"},"pdu1_enc" : {"type" : "boolean"},"size" : {"type" : "long"}}}}},"conn" : {"properties" : {"duration" : {"type" : "float"},"history" : {"type" : "keyword","ignore_above" : 1024},"ip_bytes" : {"type" : "long"},"local_orig" : {"type" : "boolean"},"local_resp" : {"type" : "boolean"},"missed_bytes" : {"type" : "long"},"state" : {"type" : "keyword","ignore_above" : 1024  }}  },  "destination" : {"properties" : {  "address" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {  "type" : "text"}}  },  "as" : {"properties" : {  "number" : {"type" : "long"  },"organization" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}}}},"bytes" : {"type" : "long"},"domain" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"file" : {"properties" : {"extension" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"fqdn" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"geo" : {"properties" : {"city_name" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"continent_code" : {"type" : "keyword","ignore_above" : 1024},"continent_name" : {"type" : "keyword","ignore_above" : 1024},"country_code2" : {"type" : "keyword","ignore_above" : 1024},"country_code3" : {"type" : "keyword","ignore_above" : 1024},"country_iso_code" : {"type" : "keyword","ignore_above" : 1024},"country_name" : {"type" : "keyword","ignore_above" : 1024},"location" : {"type" : "geo_point"},"name" : {"type" : "keyword","ignore_above" : 1024},"postal_code" : {"type" : "keyword","ignore_above" : 1024},"region_iso_code" : {"type" : "keyword","ignore_above" : 1024},"region_name" : {"type" : "keyword","ignore_above" : 1024},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"hostname" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"ip_public" : {"type" : "boolean"},"ip_type" : {"type" : "keyword"},"ip_version" : {"type" : "keyword"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"packets" : {"type" : "long"},"port" : {"type" : "long"},"user" : {"properties" : {"full_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword"}}}}},"dhcp" : {"properties" : {"agent_remote_id" : {"type" : "keyword","ignore_above" : 4096},"assigned_addr" : {"type" : "ip","copy_to" : ["related.ip"]},"circuit_id" : {"type" : "keyword","ignore_above" : 4096},"client_fqdn" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"client_message" : {"type" : "keyword","ignore_above" : 4096},"client_software" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"lease_time" : {"type" : "float"},"msg_orig" : {"type" : "ip","copy_to" : ["related.ip"]},"msg_types" : {"type" : "keyword","ignore_above" : 4096},"requested_addr" : {"type" : "ip","copy_to" : ["related.ip"]},"server_message" : {"type" : "keyword","ignore_above" : 4096},"server_software" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"subscriber_id" : {"type" : "keyword","ignore_above" : 4096}}},"dns" : {"properties" : {"answers" : {"properties" : {"class" : {"type" : "keyword","ignore_above" : 1024},"data" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ttl" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"answers_count" : {"type" : "long"},"header_flags" : {"type" : "keyword","ignore_above" : 1024},"id" : {"type" : "keyword","ignore_above" : 1024},"op_code" : {"type" : "keyword","ignore_above" : 1024},"question" : {"properties" : {"class" : {"type" : "keyword","ignore_above" : 1024},"etld_plus_one" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"registered_domain" : {"type" : "keyword","ignore_above" : 1024},"resolved_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"type" : {"type" : "keyword","ignore_above" : 1024}}},"response_code" : {"type" : "keyword","ignore_above" : 1024},"status_code" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"event" : {"properties" : {"category" : {"type" : "keyword","ignore_above" : 1024},"created" : {"type" : "date"},"dataset" : {"type" : "keyword","ignore_above" : 1024},"duration" : {"type" : "long"},"end" : {"type" : "date"},"facility" : {"type" : "keyword"},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword","ignore_above" : 1024},"kind" : {"type" : "keyword","ignore_above" : 1024},"module" : {"type" : "keyword","ignore_above" : 1024},"original" : {"type" : "keyword","index" : false,"doc_values" : false},"outcome" : {"type" : "keyword","ignore_above" : 1024},"priority" : {"type" : "keyword"},"risk_score" : {"type" : "float"},"risk_score_norm" : {"type" : "float"},"severity" : {"type" : "keyword", "fields": {"long": {"type": "long"}}},"start" : {"type" : "date"},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"file" : {"properties" : {"accessed" : {"type" : "date"},"changed" : {"type" : "alias","path" : "file.ctime"},"created" : {"type" : "date"},"ctime" : {"type" : "date"},"device" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"directory" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"extension" : {"type" : "keyword","ignore_above" : 1024},"gid" : {"type" : "keyword","ignore_above" : 1024},"group" : {"type" : "keyword","ignore_above" : 1024},"hash" : {"properties" : {"imphash" : {"type" : "keyword","ignore_above" : 4096,"copy_to" : ["related.hash"]},"md5" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"murmur3" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha1" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha256" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"sha512" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.hash"]},"ssdeep" : {"type" : "keyword","ignore_above" : 4096,"copy_to" : ["related.hash"]}}},"inode" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"mode" : {"type" : "keyword","ignore_above" : 1024},"modified" : {"type" : "alias","path" : "file.mtime"},"mtime" : {"type" : "date"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"owner" : {"type" : "keyword","ignore_above" : 1024},"path" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"size" : {"type" : "long"},"system" : {"type" : "keyword","ignore_above" : 1024},"target_path" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"type" : {"type" : "keyword","ignore_above" : 1024},"uuid" : {"type" : "keyword","ignore_above" : 1024},"x509" : {"properties" : {"certificate" : {"properties" : {"basic_constraints" : {"properties" : {"ca" : {"type" : "boolean"},"path_length" : {"type" : "long"}}},"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"exponent" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"issuer" : {"properties" : {"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"country" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"distinguished_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"locality" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organization" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organizational_unit" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"state_or_province" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"logcert" : {"type" : "boolean"},"not_after" : {"type" : "date"},"not_before" : {"type" : "date"},"public_key_algorithm" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"public_key_curve" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"public_key_exponent" : {"type" : "long"},"public_key_size" : {"type" : "long"},"public_key_type" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_dns" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_email" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"san_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"san_url" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"serial_number" : {"type" : "keyword"},"signature_algorithm" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"subject" : {"properties" : {"common_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"country" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"distinguished_name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"locality" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organization" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"organizational_unit" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"state_or_province" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"version_number" : {"type" : "keyword"}}}}},"files" : {"properties" : {"analyzers" : {"type" : "keyword","ignore_above" : 1024},"depth" : {"type" : "long"},"entropy" : {"type" : "double"},"extracted" : {"type" : "keyword","ignore_above" : 1024},"extracted_cutoff" : {"type" : "boolean"},"extracted_size" : {"type" : "long"},"is_originating" : {"type" : "boolean"},"local_origin" : {"type" : "boolean"},"missing_bytes" : {"type" : "long"},"overflow_bytes" : {"type" : "long"},"seen_bytes" : {"type" : "long"},"timedout" : {"type" : "boolean"}}},"host" : {"properties" : {"architecture" : {"type" : "keyword","ignore_above" : 1024},"host" : {"type" : "keyword","copy_to" : ["related.domain"]},"hostname" : {"type" : "keyword","copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"port" : {"type" : "long"},"type" : {"type" : "keyword","ignore_above" : 1024}}},"http" : {"properties" : {"cookie_variables" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"request" : {"properties" : {"body" : {"properties" : {"bytes" : {"type" : "long"},"content" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"bytes" : {"type" : "long"},"header_names" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"method" : {"type" : "keyword","ignore_above" : 4096},"mime_type" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"origin" : {"type" : "keyword","ignore_above" : 4096},"proxied" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"referrer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"response" : {"properties" : {"body" : {"properties" : {"bytes" : {"type" : "long"},"content" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"bytes" : {"type" : "long"},"header_names" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"informational_code" : {"type" : "long"},"informational_message" : {"type" : "keyword","ignore_above" : 4096},"mime_type" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"status_code" : {"type" : "long"},"status_name" : {"type" : "keyword","ignore_above" : 4096}}},"transaction_depth" : {"type" : "long"},"version" : {"type" : "keyword","ignore_above" : 4096}}},"labels" : {"properties" : {"weird" : {"properties" : {"name" : {"type" : "text"},"number_seen" : {"type" : "integer"}}}}},"log" : {"properties" : {"id" : {"properties" : {"cert_chain_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"client_cert_chain_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"client_cert_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"conn_uids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"flow_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"orig_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"parent_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"related_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"resp_fuids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"server_cert_fuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"suri_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"tunnel_parents" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"tx_id" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uids" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]},"uuid" : {"type" : "keyword","ignore_above" : 2048,"copy_to" : ["related.id"]}}},"level" : {"type" : "keyword","ignore_above" : 1024},"logger" : {"type" : "keyword"},"original" : {"type" : "keyword","index" : false,"doc_values" : false},"syslog" : {"properties" : {"facility" : {"properties" : {"code" : {"type" : "long"},"name" : {"type" : "keyword"}}},"priority" : {"type" : "long"},"severity" : {"properties" : {"code" : {"type" : "long"},"name" : {"type" : "keyword"}}}}}}},"message" : {"type" : "text","norms" : false},"network" : {"properties" : {"bytes" : {"type" : "long"},"community_id" : {"type" : "keyword","ignore_above" : 1024},"direction" : {"type" : "keyword","ignore_above" : 1024},"forwarded_ip" : {"type" : "ip","copy_to" : ["related.ip"]},"iana_number" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 1024},"packets" : {"type" : "long"},"protocol" : {"type" : "keyword","ignore_above" : 1024},"transport" : {"type" : "keyword","ignore_above" : 1024},"type" : {"type" : "keyword","ignore_above" : 1024},"vlan" : {"properties" : {"id" : {"type" : "integer"},"inner" : {"properties" : {"vlan" : {"properties" : {"id" : {"type" : "integer"}}}}}}}}},"observer" : {"properties" : {"hostname" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.domain"]},"ip" : {"type" : "ip"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"sensor_version" : {"type" : "keyword"},"serial_number" : {"type" : "keyword"},"sub_process" : {"type" : "keyword"},"type" : {"type" : "keyword"},"vendor" : {"type" : "keyword"},"version" : {"type" : "keyword"}}},"radius" : {"properties" : {"connect_info" : {"type" : "keyword","ignore_above" : 2048},"framed" : {"type" : "ip","copy_to" : ["related.ip"]},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"reply_msg" : {"type" : "keyword","ignore_above" : 2048},"time_to_live" : {"type" : "float"},"tunnel_client" : {"type" : "keyword","ignore_above" : 4096}}},"related" : {"properties" : {"domain" : {"type" : "keyword"},"geo" : {"type" : "geo_point"},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"ip" : {"type" : "ip"},"mac" : {"type" : "keyword"},"user" : {"type" : "keyword"},"vlan_id" : {"type" : "integer"}}},"rule" : {"properties" : {"author" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"category" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"description" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"id" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"license" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"reference" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"ruleset" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"uuid" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"version" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}}}},"server" : {"properties" : {"viz" : {"properties" : {"clr_ex" : {"type" : "text"},"clr_frac" : {"type" : "float"},"enc_dev" : {"type" : "float"},"enc_frac" : {"type" : "float"},"pdu1_enc" : {"type" : "boolean"},"size" : {"type" : "long"}}}}},"socks" : {"properties" : {"bound" : {"properties" : {"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"}}},"request" : {"properties" : {"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"name" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"}}}}},"source" : {"properties" : {"address" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"as" : {"properties" : {"number" : {"type" : "long"},"organization" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}}}},"bytes" : {"type" : "long"},"domain" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"file" : {"properties" : {"extension" : {"type" : "keyword","ignore_above" : 1024},"mime_type" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"fqdn" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"geo" : {"properties" : {"city_name" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"continent_code" : {"type" : "keyword","ignore_above" : 1024},"continent_name" : {"type" : "keyword","ignore_above" : 1024},"country_code2" : {"type" : "keyword","ignore_above" : 1024},"country_code3" : {"type" : "keyword","ignore_above" : 1024},"country_iso_code" : {"type" : "keyword","ignore_above" : 1024},"country_name" : {"type" : "keyword","ignore_above" : 1024},"location" : {"type" : "geo_point"},"name" : {"type" : "keyword","ignore_above" : 1024},"postal_code" : {"type" : "keyword","ignore_above" : 1024},"region_iso_code" : {"type" : "keyword","ignore_above" : 1024},"region_name" : {"type" : "keyword","ignore_above" : 1024},"timezone" : {"type" : "keyword","ignore_above" : 1024}}},"hostname" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"ip" : {"type" : "ip","copy_to" : ["related.ip"]},"ip_public" : {"type" : "boolean"},"ip_type" : {"type" : "keyword"},"ip_version" : {"type" : "keyword"},"mac" : {"type" : "keyword","ignore_above" : 1024,"copy_to" : ["related.mac"]},"packets" : {"type" : "long"},"port" : {"type" : "long"},"user" : {"properties" : {"full_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"hash" : {"type" : "keyword"},"id" : {"type" : "keyword"},"name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword"}}}}},"ssh" : {"properties" : {"auth_attempts" : {"type" : "long"},"auth_successful" : {"type" : "boolean"},"stepping" : {"properties" : {"direct" : {"type" : "boolean"},"dt" : {"type" : "float"}}}}},"suricata" : {"properties" : {"metadata" : {"type" : "keyword","fields" : {"text" : {"type" : "text"}}},"pcap_count" : {"type" : "long"}}},"tags" : {"type" : "keyword"},"tls" : {"properties" : {"cipher" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"client" : {"properties" : {"hash" : {"properties" : {"sha1" : {"type" : "keyword","ignore_above" : 1024}}},"issuer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ja3" : {"type" : "keyword","ignore_above" : 1024},"server_name" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"subject" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"curve" : {"type" : "keyword"},"established" : {"type" : "boolean"},"next_protocol" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"resumed" : {"type" : "boolean"},"server" : {"properties" : {"hash" : {"properties" : {"sha1" : {"type" : "keyword","ignore_above" : 1024}}},"issuer" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"ja3s" : {"type" : "keyword","ignore_above" : 1024},"subject" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}}}},"version" : {"type" : "keyword","ignore_above" : 1024},"version_protocol" : {"type" : "keyword","ignore_above" : 1024}}},"url" : {"properties" : {"domain" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.domain"]},"extension" : {"type" : "keyword","ignore_above" : 1024},"fragment" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"full" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"meta" : {"properties" : {"has_non_ascii" : {"type" : "boolean"},"has_whitespace" : {"type" : "boolean"},"paths" : {"type" : "long"},"total_length" : {"type" : "long"}}},"original" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"password" : {"type" : "keyword","ignore_above" : 1024},"path" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"port" : {"type" : "long"},"query" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}}},"scheme" : {"type" : "keyword","ignore_above" : 1024},"username" : {"type" : "keyword","ignore_above" : 1024,"fields" : {"text" : {"type" : "text"}},"copy_to" : ["related.user"]},"variables" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}}}},"user_agent" : {"properties" : {"build" : {"type" : "keyword","ignore_above" : 1024},"device" : {"properties" : {"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}}}},"major" : {"type" : "long"},"meta" : {"properties" : {"total_length" : {"type" : "long"}}},"minor" : {"type" : "long"},"minor2" : {"type" : "long"},"minor3" : {"type" : "long"},"name" : {"type" : "keyword","ignore_above" : 4096,"fields" : {"text" : {"type" : "text"}}},"original" : {"type" : "keyword","ignore_above" : 8000,"fields" : {"text" : {"type" : "text"}}},"os" : {"properties" : {"family" : {"type" : "keyword","ignore_above" : 1024},"full" : {"type" : "keyword","ignore_above" : 2048,"fields" : {"text" : {"type" : "text"}}},"kernel" : {"type" : "keyword","ignore_above" : 1024},"major" : {"type" : "keyword","ignore_above" : 1024},"minor" : {"type" : "keyword","ignore_above" : 1024},"name" : {"type" : "keyword","ignore_above" : 2048},"platform" : {"type" : "keyword","ignore_above" : 1024},"version" : {"type" : "keyword","ignore_above" : 1024}}},"patch" : {"type" : "keyword","ignore_above" : 1024},"version" : {"type" : "keyword","ignore_above" : 1024}}  }},"runtime": {  "counterflow_link": {"type": "keyword","script": {"source": "if (doc['\''source.ip'\''].size() != 0 && doc['\''destination.ip'\''].size() != 0) { String api_endpoint = '\''https://172.27.227.173/#/search/614e2800-1761-11ea-8000-3cecef425e98?nsbpf_query=host%20'\''; String host1 = doc['\''source.ip'\''].value; String host2 = doc['\''destination.ip'\''].value; ZonedDateTime zdt = doc['\''@timestamp'\''].value; zdt = zdt.minusMinutes(5); String timestamp = zdt.toString(); timestamp = timestamp.substring(0,timestamp.indexOf('\''Z'\'')); String begin = timestamp.substring(0,timestamp.indexOf('\''.'\'')) + '\''Z'\''; String url = api_endpoint + host1 + '\''%20and%20host%20'\'' + host2; if (doc['\''source.port'\''].size() != 0) { String port = doc['\''source.port'\''].value.toString(); url = url + '\''%20and%20port%20'\'' + port; } if (doc['\''destination.port'\''].size() != 0) { String port = doc['\''destination.port'\''].value.toString(); url = url + '\''%20and%20port%20'\'' + port; } emit(url + '\''&from_time='\'' + begin + '\''&to_time=%2B600'\'') }"}  }}},"settings" : {"index" : {  "refresh_interval" : "15s",  "number_of_shards" : "1", "number_of_replicas" : "0",  "lifecycle.name": "filebeat_policy"}}  }}'
do
  sleep 0.1
done

# Add garland template
until curl -XPUT "https://localhost:9200/_index_template/garland_template" --cacert ./ca.crt -s -u elastic:$ELASTIC_PASSWORD -H 'Content-Type: application/json' -d'{"index_patterns": ["filebeat-garland"],"data_stream": {},"template": {"mappings": {"properties": {"event": {"properties": {"severity": {"type":"keyword"}}}}},"settings" : {"index" : {"refresh_interval" : "15s","number_of_shards" : "1","number_of_replicas" : "0","lifecycle.name": "filebeat_policy"}}}}'
do
  sleep 0.1
done

# Load saved objects
until curl -XPOST "https://localhost:5601/api/saved_objects/_import?overwrite=true" --cacert ca.crt -u elastic:$ELASTIC_PASSWORD -H "kbn-xsrf: true" --form file=@export.ndjson
do
  sleep 0.1
done

docker-compose up -d filebeat
# rm ca.crt